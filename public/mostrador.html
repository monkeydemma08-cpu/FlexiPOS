<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KANM - Mostrador</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/styles.css" />
    <script src="js/auth.js" defer></script>
    <script src="js/mostrador.js" defer></script>
    <script src="js/mostrador-cuadre.js" defer></script>
  </head>
  <body data-role="vendedor">
    <header class="kanm-header">
      <div class="kanm-header-left">
        <div class="kanm-header-logo-container">
          <img id="kanm-header-logo" alt="" />
          <div id="kanm-header-logo-fallback" class="kanm-logo-fallback"></div>
        </div>

        <div class="kanm-header-texts">
          <div
            id="kanm-header-negocio-nombre-principal"
            class="kanm-header-title"
            data-negocio-titulo
          ></div>
          <div id="kanm-header-negocio-subtitulo" class="kanm-header-subtitle">Panel de mostrador</div>
        </div>
      </div>

      <div class="kanm-header-right">
        <div class="kanm-header-actions">
          <span class="tag-rol">Mostrador</span>
          <a class="kanm-button ghost chat-link" href="/chat.html"
            >Chat interno <span id="chat-unread-badge" class="chat-unread-badge"></span
          ></a>
          <button class="kanm-button ghost" type="button" onclick="logout()">Cerrar sesion</button>
        </div>
      </div>
    </header>

    <main class="mostrador-main">
      <section class="kanm-page-header">
        <h1 class="kanm-page-title">Mostrador / Venta rapida</h1>
        <p class="kanm-page-subtitle">Crea pedidos y cobra en un solo flujo.</p>
      </section>

      <div class="caja-tabs">
        <button class="kanm-tab active" data-tab="venta" id="tab-venta" type="button">Venta rapida</button>
        <button class="kanm-tab" data-tab="cuadre" id="tab-cuadre" type="button">Cuadre de caja</button>
      </div>

      <section class="caja-panel" id="panel-venta">
        <div class="mostrador-grid">
          <div class="mostrador-col">
            <section class="kanm-card datos-mesa">
              <div class="kanm-card-header">
                <h2>Datos del pedido</h2>
                <p class="kanm-subtitle">Registra la referencia del cliente y el tipo de servicio.</p>
              </div>
              <label for="mostrador-mesa" class="kanm-label">Mesa o cliente</label>
              <input
                type="text"
                id="mostrador-mesa"
                class="kanm-input"
                placeholder="Ej. Mesa 2 o Cliente mostrador"
                autocomplete="off"
              />
              <p class="kanm-helper" id="mostrador-identidad"></p>
              <div class="kanm-input-group">
                <label for="mostrador-servicio" class="kanm-label">Tipo de servicio</label>
                <select id="mostrador-servicio" class="kanm-input">
                  <option value="en_local">Para consumir en el negocio</option>
                  <option value="para_llevar">Para llevar</option>
                </select>
              </div>
              <div class="kanm-input-group">
                <label for="mostrador-nota" class="kanm-label">Nota para preparacion (opcional)</label>
                <textarea
                  id="mostrador-nota"
                  class="kanm-input"
                  rows="2"
                  maxlength="200"
                  placeholder="Ej. Sin cebolla, extra queso..."
                ></textarea>
                <p class="kanm-helper">Max. 200 caracteres</p>
              </div>
            </section>

            <section class="kanm-card productos">
              <div class="kanm-mesera-productos-top">
                <div class="kanm-card-header">
                  <h2>Productos</h2>
                  <p class="kanm-subtitle">Busca productos y agregalos al carrito.</p>
                </div>
                <div class="busqueda-productos">
                  <div class="buscador-input">
                  <span class="buscador-icono" aria-hidden="true"></span>
                    <input
                      type="search"
                      id="mostrador-productos-buscar"
                      class="kanm-input"
                      placeholder="Buscar por nombre..."
                      autocomplete="off"
                    />
                  </div>
                  <p class="search-results-info" id="mostrador-productos-contador"></p>
                </div>
              </div>
              <div class="kanm-mesera-productos-lista-scroll">
                <div id="mostrador-lista-productos" class="lista-productos"></div>
              </div>
            </section>

            <section class="kanm-card carrito">
              <div class="kanm-card-header">
                <h2>Carrito</h2>
                <p class="kanm-subtitle">Revisa cantidades y confirma antes de cobrar.</p>
              </div>
              <div id="mostrador-carrito" class="lista-carrito"></div>
              <div class="carrito-resumen" id="mostrador-resumen-carrito">
                <div class="resumen-item">
                  <span>Subtotal</span>
                  <span id="mostrador-resumen-subtotal">DOP 0.00</span>
                </div>
                <div class="resumen-item">
                  <span>Impuesto estimado</span>
                  <span id="mostrador-resumen-impuesto">DOP 0.00</span>
                </div>
                <div class="resumen-item total">
                  <span>Total estimado</span>
                  <span id="mostrador-resumen-total">DOP 0.00</span>
                </div>
              </div>
              <div class="mostrador-acciones">
                <div id="mostrador-mensaje" class="kanm-message"></div>
                <div class="acciones-pedido">
                  <button id="mostrador-limpiar" type="button" class="kanm-button secondary">
                    Limpiar carrito
                  </button>
                  <button id="mostrador-cancelar" type="button" class="kanm-button ghost" hidden>
                    Cancelar venta
                  </button>
                  <button id="mostrador-generar" type="button" class="kanm-button primary">
                    Crear venta
                  </button>
                </div>
              </div>
            </section>
          </div>

          <div class="kanm-card caja-detalle-card mostrador-cobro-card">
            <div class="kanm-card-header">
              <h2>Detalle de cobro</h2>
              <p class="kanm-subtitle">Aplica descuentos, propina y registra el pago.</p>
            </div>

            <div id="mostrador-cobro-placeholder" class="kanm-empty-message caja-detalle-placeholder">
              Crea una venta para ver el detalle y cobrar.
            </div>

            <form id="mostrador-cobro-form" class="kanm-form" novalidate hidden>
              <div class="kanm-message" id="mostrador-cobro-mensaje"></div>

              <div class="caja-detalle-info" id="mostrador-detalle-info"></div>
              <div class="caja-items" id="mostrador-detalle-items"></div>

              <div class="kanm-form-grid">
                <div class="kanm-input-group">
                  <label for="mostrador-descuento">Descuento (%)</label>
                  <input type="number" id="mostrador-descuento" min="0" max="100" step="0.5" value="0" />
                </div>
                <div class="kanm-input-group">
                  <label for="mostrador-propina">Propina legal (%)</label>
                  <input type="number" id="mostrador-propina" min="0" max="100" step="0.5" value="10" />
                </div>

                <div class="kanm-input-group">
                  <label for="mostrador-cliente-buscar">Buscar cliente</label>
                  <input
                    type="text"
                    id="mostrador-cliente-buscar"
                    list="mostrador-clientes"
                    placeholder="Nombre o documento"
                  />
                  <datalist id="mostrador-clientes"></datalist>
                </div>

                <div class="kanm-input-group">
                  <label for="mostrador-cliente-nombre">Cliente / Razon social</label>
                  <input type="text" id="mostrador-cliente-nombre" placeholder="Consumidor final" />
                </div>

                <div class="kanm-input-group">
                  <label for="mostrador-cliente-documento">RNC / Cedula</label>
                  <input type="text" id="mostrador-cliente-documento" placeholder="00000000000" />
                </div>

                <div class="kanm-input-group">
                  <label for="mostrador-tipo-comprobante">Tipo de comprobante</label>
                  <select id="mostrador-tipo-comprobante">
                    <option value="B02">B02 - Consumidor final</option>
                    <option value="B01">B01 - Credito fiscal</option>
                    <option value="B14">B14 - Gastos menores</option>
                    <option value="Sin comprobante">Sin comprobante</option>
                  </select>
                </div>

                <div class="kanm-input-group">
                  <label for="mostrador-ncf-manual">NCF (opcional)</label>
                  <input type="text" id="mostrador-ncf-manual" placeholder="Dejar en blanco para generar" />
                </div>

                <div class="kanm-input-group">
                  <label for="mostrador-comentarios">Notas internas</label>
                  <textarea id="mostrador-comentarios" rows="2" placeholder="Comentarios del pago"></textarea>
                </div>

                <div class="kanm-card-subsection">
                  <div class="kanm-card-header">
                    <h3>Metodos de pago</h3>
                    <p class="kanm-subtitle">Selecciona el metodo y completa los montos.</p>
                  </div>
                  <div class="kanm-form-grid cols-2">
                    <div class="kanm-input-group">
                      <label for="mostrador-pago-metodo">Selecciona el metodo</label>
                      <select id="mostrador-pago-metodo">
                        <option value="efectivo">Efectivo</option>
                        <option value="tarjeta">Tarjeta</option>
                        <option value="transferencia">Transferencia / Deposito</option>
                        <option value="combinado">Combinado</option>
                      </select>
                    </div>
                    <div class="kanm-input-group" data-metodo="efectivo combinado">
                      <label for="mostrador-pago-efectivo-entregado">Efectivo recibido</label>
                      <input
                        type="text"
                        id="mostrador-pago-efectivo-entregado"
                        inputmode="decimal"
                        data-money
                        placeholder="0.00"
                      />
                    </div>
                    <div class="kanm-input-group" data-metodo="tarjeta combinado">
                      <label for="mostrador-pago-tarjeta">Tarjeta</label>
                      <input
                        type="text"
                        id="mostrador-pago-tarjeta"
                        inputmode="decimal"
                        data-money
                        placeholder="0.00"
                      />
                    </div>
                    <div class="kanm-input-group" data-metodo="transferencia combinado">
                      <label for="mostrador-pago-transferencia">Transferencia / Deposito</label>
                      <input
                        type="text"
                        id="mostrador-pago-transferencia"
                        inputmode="decimal"
                        data-money
                        placeholder="0.00"
                      />
                    </div>
                    <div class="kanm-input-group" data-metodo="efectivo combinado">
                      <label>Cambio a entregar</label>
                      <div id="mostrador-pago-cambio" class="pago-cambio-display">DOP&nbsp;0.00</div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="caja-resumen">
                <div class="flex-between">
                  <span>Subtotal</span>
                  <span id="mostrador-cobro-subtotal">DOP&nbsp;0.00</span>
                </div>
                <div class="flex-between">
                  <span>Impuesto</span>
                  <span id="mostrador-cobro-impuesto">DOP&nbsp;0.00</span>
                </div>
                <div class="flex-between">
                  <span>Propina</span>
                  <span id="mostrador-cobro-propina">DOP&nbsp;0.00</span>
                </div>
                <div class="flex-between">
                  <span>Descuento</span>
                  <span id="mostrador-cobro-descuento">- DOP&nbsp;0.00</span>
                </div>
                <div class="flex-between total">
                  <span>Total a cobrar</span>
                  <span id="mostrador-cobro-total">DOP&nbsp;0.00</span>
                </div>
              </div>

              <div class="caja-acciones">
                <button type="button" class="kanm-button secondary" id="mostrador-recalcular">
                  Recalcular montos
                </button>
                <button type="submit" class="kanm-button primary" id="mostrador-cobrar">
                  Confirmar pago
                </button>
              </div>

              <div class="caja-factura" id="mostrador-factura-acciones" hidden>
                <p class="kanm-subtitle">Factura generada:</p>
                <div class="caja-factura-info" id="mostrador-factura-info"></div>
                <div class="caja-acciones">
                  <button type="button" class="kanm-button" id="mostrador-imprimir">Ver / Imprimir factura</button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </section>

      <section class="caja-panel hidden" id="panel-cuadre">
        <div class="kanm-card caja-cuadre-card">
          <div class="kanm-card-header">
            <h2>Cuadre de caja</h2>
            <p class="kanm-subtitle">
              Revisa el total registrado por el sistema y documenta el cuadre fisico del dia.
            </p>
          </div>

          <div id="cuadre-mensaje" class="kanm-message"></div>

          <form id="cuadre-form" class="kanm-form" novalidate>
            <div class="caja-cuadre-form">
              <div class="caja-cuadre-columns">
                <div class="caja-cuadre-col">
                  <div class="caja-cuadre-section">
                    <h3 class="caja-cuadre-title">Datos del cuadre</h3>
                    <div class="caja-cuadre-grid">
                      <div class="kanm-input-group">
                        <label for="cuadre-fecha">Fecha del cuadre</label>
                        <input type="date" id="cuadre-fecha" />
                      </div>
                      <div class="kanm-input-group">
                        <label for="cuadre-fondo-inicial">Fondo de caja inicial</label>
                        <input
                          type="text"
                          id="cuadre-fondo-inicial"
                          inputmode="decimal"
                          data-money
                          placeholder="0.00"
                        />
                      </div>
                      <div class="kanm-input-group">
                        <label for="cuadre-total-declarado">Monto contado en caja</label>
                        <input
                          type="text"
                          id="cuadre-total-declarado"
                          inputmode="decimal"
                          data-money
                          placeholder="0.00"
                        />
                      </div>
                      <div class="kanm-input-group">
                        <label for="cuadre-usuario">Nombre de quien cuadra</label>
                        <input type="text" id="cuadre-usuario" placeholder="Nombre" />
                      </div>
                    </div>
                  </div>
                  <div class="caja-cuadre-section">
                    <h3 class="caja-cuadre-title">Diferencia y esperados</h3>
                    <div class="caja-cuadre-grid two-cols">
                      <div class="kanm-input-group">
                        <label for="cuadre-total-sistema">Total en sistema</label>
                        <input type="text" id="cuadre-total-sistema" readonly />
                        <small class="kanm-subtitle">
                          Pedidos pagados: <span id="cuadre-cantidad-pedidos">0</span>
                        </small>
                      </div>
                      <div class="kanm-input-group">
                        <label for="cuadre-efectivo-esperado">Efectivo esperado</label>
                        <input type="text" id="cuadre-efectivo-esperado" readonly />
                      </div>
                      <div class="kanm-input-group">
                        <label>Diferencia</label>
                        <div class="cuadre-diferencia" id="cuadre-diferencia" data-sign="neutral">DOP&nbsp;0.00</div>
                      </div>
                      <div class="kanm-input-group">
                        <label for="cuadre-salidas-display">Salidas de caja</label>
                        <input type="text" id="cuadre-salidas-display" readonly />
                      </div>
                    </div>
                  </div>
                </div>
                <div class="caja-cuadre-col">
                  <div class="caja-cuadre-section">
                    <h3 class="caja-cuadre-title">Ventas por metodo</h3>
                    <div class="caja-cuadre-grid">
                      <div class="kanm-input-group">
                        <label for="cuadre-total-efectivo">Ventas en efectivo</label>
                        <input type="text" id="cuadre-total-efectivo" readonly />
                      </div>
                      <div class="kanm-input-group">
                        <label for="cuadre-total-tarjeta">Ventas en tarjeta</label>
                        <input type="text" id="cuadre-total-tarjeta" readonly />
                      </div>
                      <div class="kanm-input-group">
                        <label for="cuadre-total-transferencia">Ventas en transferencia</label>
                        <input type="text" id="cuadre-total-transferencia" readonly />
                      </div>
                      <div class="kanm-input-group">
                        <label for="cuadre-total-general">Ventas totales (con propina)</label>
                        <input type="text" id="cuadre-total-general" readonly />
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="kanm-input-group">
              <label for="cuadre-observaciones">Observaciones</label>
              <textarea id="cuadre-observaciones" rows="2" placeholder="Comentarios opcionales"></textarea>
            </div>

            <div class="cuadre-summary-grid">
              <div class="cuadre-summary-card">
                <span class="pill-label">Fondo inicial</span>
                <strong id="cuadre-fondo-display">DOP&nbsp;0.00</strong>
              </div>
              <div class="cuadre-summary-card">
                <span class="pill-label">Ventas en efectivo</span>
                <strong id="cuadre-total-efectivo">DOP&nbsp;0.00</strong>
              </div>
              <div class="cuadre-summary-card">
                <span class="pill-label">Tarjeta</span>
                <strong id="cuadre-total-tarjeta">DOP&nbsp;0.00</strong>
              </div>
              <div class="cuadre-summary-card">
                <span class="pill-label">Transferencia</span>
                <strong id="cuadre-total-transferencia">DOP&nbsp;0.00</strong>
              </div>
              <div class="cuadre-summary-card">
                <span class="pill-label">Salidas en efectivo</span>
                <strong id="cuadre-salidas-display">DOP&nbsp;0.00</strong>
              </div>
              <div class="cuadre-summary-card">
                <span class="pill-label">Descuentos aplicados</span>
                <strong id="cuadre-total-descuentos">DOP&nbsp;0.00</strong>
              </div>
              <div class="cuadre-summary-card">
                <span class="pill-label">Total ventas</span>
                <strong id="cuadre-total-general">DOP&nbsp;0.00</strong>
              </div>
              <div class="cuadre-summary-card destacado">
                <span class="pill-label">Efectivo esperado</span>
                <strong id="cuadre-efectivo-esperado">DOP&nbsp;0.00</strong>
              </div>
            </div>

            <div class="caja-acciones">
              <button type="button" class="kanm-button primary" id="cuadre-registrar">
                Registrar cuadre de caja
              </button>
            </div>
          </form>

          <div class="kanm-card-subsection cuadre-salidas">
            <div class="kanm-card-header">
              <h3>Salidas de efectivo</h3>
              <p class="kanm-subtitle">Registra retiros de efectivo para que el efectivo esperado sea preciso.</p>
            </div>
            <div id="salidas-mensaje" class="kanm-message"></div>
            <div class="cuadre-salidas-form">
              <div class="kanm-input-group">
                <label for="salida-descripcion">Descripcion</label>
                <input type="text" id="salida-descripcion" placeholder="Ej. compra de materiales" />
              </div>
              <div class="kanm-input-group">
                <label for="salida-monto">Monto</label>
                <input type="text" id="salida-monto" inputmode="decimal" data-money placeholder="0.00" />
              </div>
              <div class="cuadre-salidas-acciones">
                <button type="button" class="kanm-button ghost" id="salida-agregar">Agregar salida de caja</button>
              </div>
            </div>
            <div class="salidas-lista" id="salida-lista"></div>
          </div>

          <div class="kanm-card-subsection">
            <div class="kanm-card-header">
              <h3>Detalle del cuadre actual</h3>
              <p class="kanm-subtitle">Revisa los pedidos pagados en este turno antes de cerrar.</p>
            </div>
            <div class="caja-acciones">
              <button type="button" class="kanm-button ghost" id="cuadre-ver-detalle">
                Ver detalle del cuadre actual
              </button>
            </div>
            <div class="kanm-table-wrapper" id="cuadre-detalle-wrapper" hidden>
              <table class="kanm-table condensed">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Mesa / Cliente</th>
                    <th>Fecha pago</th>
                    <th>Metodo de pago</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody id="cuadre-detalle-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
    </main>
    <div id="toast-container"></div>
  </body>
</html>
